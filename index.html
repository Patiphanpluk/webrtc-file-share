<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üì° WebRTC File Share & Chat</title>
<!-- ‡πÇ‡∏´‡∏•‡∏î Tailwind CSS CDN ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏ó‡∏µ‡πà‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏°‡πÅ‡∏•‡∏∞‡∏ï‡∏≠‡∏ö‡∏™‡∏ô‡∏≠‡∏á‡∏ï‡πà‡∏≠‡∏ó‡∏∏‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ -->
<script src="https://cdn.tailwindcss.com"></script>
<style>
/* Custom styles */
body { font-family: 'Inter', sans-serif; background: #f0f4f8; display: flex; justify-content: center; align-items: flex-start; min-height: 100vh; padding: 20px;}
.card { background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 8px 16px rgba(0,0,0,0.1); width: 95%; max-width: 450px; text-align: center; margin-top: 20px;}
input, button, select { padding: 12px; border-radius: 8px; margin: 8px 0; font-size: 15px; width: 100%; border: 1px solid #d1d5db; transition: border-color 0.3s;}
input:focus { border-color: #2563eb; outline: none; }
button { background: #2563eb; color: white; cursor: pointer; font-weight: 600; border: none; transition: background-color 0.3s;}
button:hover { background: #1e40af; }
#messages { height: 180px; overflow-y: auto; background: #f8fafc; padding: 10px; border-radius: 8px; text-align: left; margin-top: 15px; border: 1px solid #e2e8f0; }
.msg { background: #e0f2fe; padding: 8px 12px; margin: 6px 0; border-radius: 6px; word-wrap: break-word; font-size: 14px;}
.msg a { color: #1e40af; text-decoration: underline; font-weight: 500;}
#qr { margin: 15px auto; border: 4px solid #fff; border-radius: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);}
.status { color: #10b981; font-weight: 500; margin-top: 10px; }
</style>
</head>
<body>
<div class="card">
<h2 class="text-3xl font-bold text-gray-800 mb-2">üì° ‡πÅ‡∏•‡∏Å‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÑ‡∏ü‡∏•‡πå & ‡πÅ‡∏ä‡∏ó</h2>
<p id="auth-status" class="text-sm text-yellow-600 mb-4">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô...</p>

<div id="app-content" style="display:none;">
    <p id="room-id" class="text-lg font-medium text-gray-700 mb-3">‡∏£‡∏´‡∏±‡∏™‡∏´‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì: -</p>
    <canvas id="qr" class="w-40 h-40"></canvas>
    
    <input id="join-room" placeholder="‡∏õ‡πâ‡∏≠‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏´‡πâ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏° (8 ‡∏´‡∏•‡∏±‡∏Å)" class="mb-2">
    <button id="join-btn" class="bg-purple-600 hover:bg-purple-700">‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏´‡πâ‡∏≠‡∏á</button>

    <div id="connection-status" class="status"></div>

    <div id="chat-box" style="display:none;">
        <div id="messages"></div>
        <input id="message" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà..." class="mt-4">
        <button id="send" class="bg-green-600 hover:bg-green-700">‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</button>
        <label for="fileInput" class="block w-full text-center py-2 px-4 rounded-lg bg-yellow-500 text-white cursor-pointer hover:bg-yellow-600 mt-2">
            ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á
        </label>
        <input type="file" id="fileInput" class="hidden">
    </div>
</div>
</div>

<script type="module">
// ----------------------------------------------------------------------
// üö® ‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ Firebase ‡πÅ‡∏•‡∏∞ SimplePeer
// ----------------------------------------------------------------------
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getDatabase, ref, push, onChildAdded, set } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";
import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import SimplePeerLib from "https://cdn.jsdelivr.net/npm/simple-peer@9.11.1/simplepeer.min.js";
const SimplePeer = SimplePeerLib.default;
import QRCode from "https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js";

// ----------------------------------------------------------------------
// ‚ö†Ô∏è ‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà Firebase Config ‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡πà‡∏≤‡∏à‡∏£‡∏¥‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
// ----------------------------------------------------------------------
const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_AUTH_DOMAIN",
    databaseURL: "YOUR_DATABASE_URL", // ‡πÄ‡∏ä‡πà‡∏ô https://your-project-default-rtdb.asia-southeast1.firebasedatabase.app
    projectId: "YOUR_PROJECT_ID",
    storageBucket: "YOUR_STORAGE_BUCKET",
    messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
    appId: "YOUR_APP_ID"
};

// üî∏ ‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô Firebase
if (!firebaseConfig.apiKey.includes("YOUR_")) {
    const app = initializeApp(firebaseConfig);
    var db = getDatabase(app);
    var auth = getAuth(app);
} else {
    document.getElementById('auth-status').textContent = 'üî¥ ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà Firebase Config ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á';
    throw new Error("Please update firebaseConfig with your actual credentials.");
}

let userId = null;
let peer = null;
let currentRoomId = null;

// ----------------------------------------------------------------------
// üîë ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (Anonymous Authentication)
// ----------------------------------------------------------------------
async function authenticate() {
    document.getElementById('auth-status').textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô...';
    try {
        const userCredential = await signInAnonymously(auth);
        userId = userCredential.user.uid;
        
        document.getElementById('auth-status').textContent = `‚úÖ ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (User ID: ${userId.substring(0, 8)}...)`;
        document.getElementById('auth-status').classList.replace('text-yellow-600', 'text-green-600');
        document.getElementById('app-content').style.display = 'block';
        setupRoom(); // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏´‡πâ‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‡πÅ‡∏•‡πâ‡∏ß
    } catch (error) {
        console.error("Authentication failed:", error);
        document.getElementById('auth-status').textContent = '‚ùå ‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß';
        document.getElementById('auth-status').classList.replace('text-yellow-600', 'text-red-600');
    }
}

// ----------------------------------------------------------------------
// ‚öôÔ∏è ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏Å‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Peer
// ----------------------------------------------------------------------
function setupRoom() {
    // 1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏û‡∏≤‡∏£‡∏≤‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå URL ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏´‡πâ‡∏≠‡∏á
    const params = new URLSearchParams(location.search);
    const joinRoomId = params.get("room");
    
    if (joinRoomId) {
        joinRoomFunc(joinRoomId);
    } else {
        startNewRoom();
    }

    // 2. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏õ‡∏∏‡πà‡∏° '‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏´‡πâ‡∏≠‡∏á'
    document.getElementById("join-btn").onclick = () => {
        const r = document.getElementById("join-room").value.trim();
        if(r) joinRoomFunc(r);
    };

    // 3. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏•‡∏∞‡πÑ‡∏ü‡∏•‡πå
    document.getElementById("send").onclick = handleSendText;
    document.getElementById("fileInput").onchange = handleSendFile;
}

// ----------------------------------------------------------------------
// üåü ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà (Peer Initiator)
// ----------------------------------------------------------------------
function startNewRoom() {
    currentRoomId = Math.random().toString(36).substring(2,10);
    initializePeer(currentRoomId, true);
    
    document.getElementById("room-id").textContent = "‡∏£‡∏´‡∏±‡∏™‡∏´‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì: " + currentRoomId;
    QRCode.toCanvas(document.getElementById("qr"), location.origin + "?room=" + currentRoomId, { width: 160 });
}

// ----------------------------------------------------------------------
// ü§ù ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏´‡πâ‡∏≠‡∏á (Peer Non-Initiator)
// ----------------------------------------------------------------------
function joinRoomFunc(rid) {
    currentRoomId = rid;
    document.getElementById("room-id").textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏´‡πâ‡∏≠‡∏á: " + rid;
    document.getElementById("join-room").value = rid;
    document.getElementById("join-btn").disabled = true;

    initializePeer(rid, false);
    
    QRCode.toCanvas(document.getElementById("qr"), location.origin + "?room=" + rid, { width: 160 });
}

// ----------------------------------------------------------------------
// üåê ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏£‡∏ß‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á Peer ‡πÅ‡∏•‡∏∞ Signaling
// ----------------------------------------------------------------------
function initializePeer(roomId, isInitiator) {
    // ‡∏ó‡∏≥‡∏•‡∏≤‡∏¢ Peer ‡πÄ‡∏î‡∏¥‡∏° ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
    if (peer && !peer.destroyed) {
        peer.destroy();
    }
    
    // Path ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Signaling ‡πÉ‡∏ô Realtime Database
    const connRef = ref(db, `webrtc_signals/${roomId}`);
    document.getElementById('connection-status').textContent = 'üü° ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Peer...';

    peer = new SimplePeer({ initiator: isInitiator, trickle: false });

    // ‡∏™‡πà‡∏á Signal ‡πÑ‡∏õ Firebase
    peer.on('signal', data => {
        // ‡πÉ‡∏ä‡πâ push() ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á node ‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡∏°‡∏µ signal
        push(connRef, JSON.stringify(data)).catch(e => console.error("Error pushing signal:", e));
    });

    // ‡∏£‡∏±‡∏ö Signal ‡∏à‡∏≤‡∏Å Firebase
    // ‡πÉ‡∏ä‡πâ onChildAdded ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ö signal ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏™‡πà‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
    onChildAdded(connRef, snap => {
        try {
            const data = JSON.parse(snap.val());
            if (!peer.destroyed && data) {
                peer.signal(data);
            }
            // ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö Signal ‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏î‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î
            // set(ref(db, `webrtc_signals/${roomId}/${snap.key}`), null);
        } catch (e) {
            console.error("Error signaling peer:", e);
        }
    });

    // ---------------------- Events ----------------------
    peer.on('connect', () => {
        document.getElementById("chat-box").style.display = "block";
        document.getElementById('connection-status').textContent = 'üü¢ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Peer-to-Peer ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! (‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏´‡∏±‡∏™)';
        addMsg("‚úÖ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏ä‡∏ó‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢");
        // Clear old signals after successful connection (optional, for cleanliness)
        // set(connRef, null); 
    });

    peer.on("data", handleReceiveData);
    
    peer.on('error', (err) => {
        document.getElementById('connection-status').textContent = 'üî¥ ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠';
        console.error('Peer Error:', err);
    });
    
    peer.on('close', () => {
        document.getElementById('connection-status').textContent = '‚ö´ ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ñ‡∏π‡∏Å‡∏ï‡∏±‡∏î';
        document.getElementById("chat-box").style.display = "none";
        addMsg("‚ö†Ô∏è ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ñ‡∏π‡∏Å‡∏ï‡∏±‡∏î‡πÅ‡∏•‡πâ‡∏ß ‡πÇ‡∏õ‡∏£‡∏î‡∏•‡∏≠‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà");
    });
}

// ----------------------------------------------------------------------
// üì§ ‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
// ----------------------------------------------------------------------
function handleSendText() {
    const text = document.getElementById("message").value.trim();
    if (!text || !peer || peer.destroyed || !peer.connected) return;
    
    try {
        // ‡πÉ‡∏ä‡πâ userId ‡∏™‡∏±‡πâ‡∏ô‡πÜ ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡∏ö‡πà‡∏á‡∏ä‡∏µ‡πâ‡∏ú‡∏π‡πâ‡∏™‡πà‡∏á
        peer.send(JSON.stringify({ type: "text", text, sender: userId.substring(0, 8) }));
        addMsg(`üßç‚Äç‚ôÇÔ∏è (‡∏Ñ‡∏∏‡∏ì): ${text}`);
        document.getElementById("message").value = "";
    } catch (e) {
        console.error("Error sending text:", e);
    }
}

function handleSendFile(e) {
    const file = e.target.files[0];
    if (!file || !peer || peer.destroyed || !peer.connected) return;

    // WebRTC ‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏Ç‡∏ô‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà ‡πÇ‡∏î‡∏¢‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ‡πÑ‡∏°‡πà‡∏Ñ‡∏ß‡∏£‡πÄ‡∏Å‡∏¥‡∏ô 20-30MB
    const MAX_FILE_SIZE = 20 * 1024 * 1024; // 20 MB
    if (file.size > MAX_FILE_SIZE) {
        addMsg(`‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏î‡πâ: ‡πÑ‡∏ü‡∏•‡πå‡∏°‡∏µ‡∏Ç‡∏ô‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏Å‡∏¥‡∏ô ${(MAX_FILE_SIZE / 1024 / 1024).toFixed(0)}MB`);
        e.target.value = null; // Reset input
        return;
    }
    
    const reader = new FileReader();
    reader.onload = () => {
        try {
            // ‡∏™‡πà‡∏á‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏õ‡πá‡∏ô Data URL (Base64)
            peer.send(JSON.stringify({ type: "file", name: file.name, data: reader.result }));
            addMsg(`üì§ ‡∏™‡πà‡∏á‡πÑ‡∏ü‡∏•‡πå: ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)`);
        } catch (e) {
            console.error("Error sending file data:", e);
            addMsg("‚ùå ‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß");
        }
        e.target.value = null; // Reset input after use
    };
    reader.readAsDataURL(file);
}

// ----------------------------------------------------------------------
// üì• ‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
// ----------------------------------------------------------------------
function handleReceiveData(data) {
    try {
        const d = JSON.parse(data);
        if (d.type === "text") {
            const sender = d.sender || 'üë§';
            addMsg(`${sender}: ${d.text}`);
        } else if (d.type === "file") {
            const fileMsg = document.createElement("div");
            fileMsg.className = "msg bg-yellow-100";
            
            const a = document.createElement("a");
            a.href = d.data;
            a.download = d.name;
            a.textContent = `üìÅ ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå: ${d.name} (‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î)`;
            a.target = "_blank";
            a.classList.add('font-bold', 'hover:text-red-600', 'block', 'mt-1');
            
            fileMsg.appendChild(a);
            document.getElementById("messages").appendChild(fileMsg);
            
            const m = document.getElementById("messages");
            m.scrollTop = m.scrollHeight;
        }
    } catch (e) {
        console.error("Error parsing received data:", e);
    }
}

// ----------------------------------------------------------------------
// üí¨ ‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏ô‡πÅ‡∏ä‡∏ó
// ----------------------------------------------------------------------
function addMsg(txt){
    const div = document.createElement("div");
    div.textContent = txt;
    div.className = "msg";
    document.getElementById("messages").appendChild(div);
    const m = document.getElementById("messages");
    m.scrollTop = m.scrollHeight;
}

// ----------------------------------------------------------------------
// üöÄ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÅ‡∏≠‡∏õ‡∏û‡∏•‡∏¥‡πÄ‡∏Ñ‡∏ä‡∏±‡∏ô
// ----------------------------------------------------------------------
authenticate();
</script>
</body>
</html>
