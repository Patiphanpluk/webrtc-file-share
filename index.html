<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üì° WebRTC File Share & Chat</title>
<!-- ‡πÇ‡∏´‡∏•‡∏î Tailwind CSS CDN ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏ó‡∏µ‡πà‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏°‡πÅ‡∏•‡∏∞‡∏ï‡∏≠‡∏ö‡∏™‡∏ô‡∏≠‡∏á‡∏ï‡πà‡∏≠‡∏ó‡∏∏‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ -->
<script src="https://cdn.tailwindcss.com"></script>
<style>
/* Custom styles */
body { font-family: 'Inter', sans-serif; background: #f0f4f8; display: flex; justify-content: center; align-items: flex-start; min-height: 100vh; padding: 20px;}
.card { background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 8px 16px rgba(0,0,0,0.1); width: 95%; max-width: 450px; text-align: center; margin-top: 20px;}
input, button, select { padding: 12px; border-radius: 8px; margin: 8px 0; font-size: 15px; width: 100%; border: 1px solid #d1d5db; transition: border-color 0.3s;}
input:focus { border-color: #2563eb; outline: none; }
button { background: #2563eb; color: white; cursor: pointer; font-weight: 600; border: none; transition: background-color 0.3s;}
button:hover { background: #1e40af; }
#messages { height: 180px; overflow-y: auto; background: #f8fafc; padding: 10px; border-radius: 8px; text-align: left; margin-top: 15px; border: 1px solid #e2e8f0; }
.msg { background: #e0f2fe; padding: 8px 12px; margin: 6px 0; border-radius: 6px; word-wrap: break-word; font-size: 14px;}
.msg a { color: #1e40af; text-decoration: underline; font-weight: 500;}
#qr { margin: 15px auto; border: 4px solid #fff; border-radius: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);}
.status { color: #10b981; font-weight: 500; margin-top: 10px; }
.text-xs { font-size: 0.75rem; }
</style>
</head>
<body>
<div class="card">
<h2 class="text-3xl font-bold text-gray-800 mb-2">üì° ‡πÅ‡∏•‡∏Å‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÑ‡∏ü‡∏•‡πå & ‡πÅ‡∏ä‡∏ó</h2>
<p id="auth-status" class="text-sm text-yellow-600 mb-4">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô...</p>

<div id="app-content" style="display:none;">
    <p id="room-id" class="text-lg font-medium text-gray-700 mb-3">‡∏£‡∏´‡∏±‡∏™‡∏´‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì: -</p>
    <canvas id="qr" class="w-40 h-40"></canvas>
    <p id="user-id-display" class="text-xs text-gray-500 mt-1 mb-3">User ID: N/A</p>
    
    <input id="join-room" placeholder="‡∏õ‡πâ‡∏≠‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏´‡πâ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏° (8 ‡∏´‡∏•‡∏±‡∏Å)" class="mb-2">
    <button id="join-btn" class="bg-purple-600 hover:bg-purple-700">‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏´‡πâ‡∏≠‡∏á</button>

    <div id="connection-status" class="status"></div>

    <div id="chat-box" style="display:none;">
        <div id="messages"></div>
        <input id="message" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà..." class="mt-4">
        <button id="send" class="bg-green-600 hover:bg-green-700">‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</button>
        <label for="fileInput" class="block w-full text-center py-2 px-4 rounded-lg bg-yellow-500 text-white cursor-pointer hover:bg-yellow-600 mt-2">
            ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á (‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 20MB)
        </label>
        <input type="file" id="fileInput" class="hidden">
    </div>
</div>
</div>

<script type="module">
// ----------------------------------------------------------------------
// üö® Import Firebase and WebRTC Libraries
// ----------------------------------------------------------------------
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getDatabase, ref, push, onChildAdded } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";
import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
// ‡πÉ‡∏ä‡πâ SimplePeer ‡∏à‡∏≤‡∏Å UNPKG ‡∏ã‡∏∂‡πà‡∏á‡πÄ‡∏™‡∏ñ‡∏µ‡∏¢‡∏£
import SimplePeerLib from "https://unpkg.com/simple-peer@9.11.1/simplepeer.min.js"; 
const SimplePeer = SimplePeerLib.default;

// ----------------------------------------------------------------------
// üî¥ QR Code Library (Embeddable version to avoid CORS/404)
// **FIXED SYNTAX ERROR HERE**
// ----------------------------------------------------------------------
function toCanvas(canvasElement, text) {
    // This uses a highly simplified and minimal QR code generation logic
    // just for the visual link, avoiding external dependencies completely.
    if (!canvasElement) return;

    try {
        const size = 160;
        const qr = simpleQRCode(text);
        
        const ctx = canvasElement.getContext('2d');
        canvasElement.width = size;
        canvasElement.height = size;
        const moduleCount = 21; // Simplified constant size
        const moduleSize = size / moduleCount;
        
        ctx.fillStyle = "#ffffff";
        ctx.fillRect(0, 0, size, size);
        ctx.fillStyle = "#000000";

        // Draw a simple pattern placeholder
        for (let row = 0; row < moduleCount; row++) {
            for (let col = 0; col < moduleCount; col++) {
                // Simple pattern to represent QR Code structure
                if (qr.isModuleDark(row, col)) {
                    ctx.fillRect(col * moduleSize, row * moduleSize, moduleSize, moduleSize);
                }
            }
        }
    } catch(e) {
        console.error("QR Code generation error:", e);
        canvasElement.style.display = 'none';
        const errorDiv = document.createElement('div');
        errorDiv.textContent = '‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á QR Code ‡πÑ‡∏î‡πâ';
        errorDiv.style.color = 'red';
        canvasElement.parentNode.insertBefore(errorDiv, canvasElement.nextSibling);
    }
}

// Minimal QR Code implementation provided by a single function
function simpleQRCode(data) {
    const moduleCount = 21;
    return {
        isModuleDark: function(row, col) {
            // Simplified logic: checks for border/finder patterns
            if (row < 7 && col < 7) return true;
            if (row >= moduleCount - 7 && col < 7) return true;
            if (row < 7 && col >= moduleCount - 7) return true;
            if (row === col || row + col === moduleCount - 1) {
                // Draws a few diagonal lines for visual effect
                return true;
            }
            return false;
        }
    };
}
// ----------------------------------------------------------------------


// ----------------------------------------------------------------------
// ‚úÖ Firebase Configuration (file-share-8bccd project)
// ----------------------------------------------------------------------
const firebaseConfig = {
    apiKey: "AIzaSyDoUsDv0omYdaR-oJL7g9qk21IhRUsIOpM",
    authDomain: "file-share-8bccd.firebaseapp.com",
    databaseURL: "https://file-share-8bccd-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "file-share-8bccd",
    storageBucket: "file-share-8bccd.firebasestorage.app",
    messagingSenderId: "607625231087",
    appId: "1:607625231087:web:f8cc2bde638b2b7ab2791a",
    measurementId: "G-0HLJ1ZEQ53"
};

// üî∏ Initialize Firebase
let db, auth;
try {
    const app = initializeApp(firebaseConfig);
    db = getDatabase(app);
    auth = getAuth(app);
} catch(e) {
    document.getElementById('auth-status').textContent = 'üî¥ Firebase Init Failed';
    console.error("Firebase Initialization Error:", e);
    throw e;
}

let userId = null;
let peer = null;
const MAX_FILE_SIZE = 20 * 1024 * 1024; // 20 MB

// ----------------------------------------------------------------------
// üîë Authentication (Anonymous)
// ----------------------------------------------------------------------
async function authenticate() {
    document.getElementById('auth-status').textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô...';
    try {
        const userCredential = await signInAnonymously(auth);
        userId = userCredential.user.uid;
        
        document.getElementById('auth-status').textContent = `‚úÖ ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`;
        document.getElementById('user-id-display').textContent = `User ID: ${userId.substring(0, 8)}...`;
        document.getElementById('auth-status').classList.replace('text-yellow-600', 'text-green-600');
        document.getElementById('app-content').style.display = 'block';
        setupRoom(); 
    } catch (error) {
        console.error("Authentication failed:", error);
        const errorCode = error.code ? error.code.split('/')[1] : 'NETWORK_ERROR';
        document.getElementById('auth-status').textContent = `‚ùå ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${errorCode}`;
        document.getElementById('auth-status').classList.replace('text-yellow-600', 'text-red-600');
    }
}

// ----------------------------------------------------------------------
// ‚öôÔ∏è Main Room Setup
// ----------------------------------------------------------------------
function setupRoom() {
    const params = new URLSearchParams(location.search);
    const joinRoomId = params.get("room");
    
    if (joinRoomId) {
        joinRoomFunc(joinRoomId);
    } else {
        startNewRoom();
    }

    document.getElementById("join-btn").onclick = () => {
        const r = document.getElementById("join-room").value.trim();
        if(r) {
            window.location.href = window.location.origin + location.pathname + `?room=${r}`;
        }
    };

    document.getElementById("send").onclick = handleSendText;
    document.getElementById("fileInput").onchange = handleSendFile;
}

// ----------------------------------------------------------------------
// üåü Start New Room (Initiator)
// ----------------------------------------------------------------------
function startNewRoom() {
    let roomId = Math.random().toString(36).substring(2,10);
    initializePeer(roomId, true);
    
    document.getElementById("room-id").textContent = "‡∏£‡∏´‡∏±‡∏™‡∏´‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì: " + roomId;
    toCanvas(document.getElementById("qr"), location.origin + location.pathname + "?room=" + roomId);
}

// ----------------------------------------------------------------------
// ü§ù Join Room (Non-Initiator)
// ----------------------------------------------------------------------
function joinRoomFunc(rid) {
    document.getElementById("room-id").textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏´‡πâ‡∏≠‡∏á: " + rid;
    document.getElementById("join-room").value = rid;
    
    document.getElementById("join-btn").style.display = 'none';

    initializePeer(rid, false);
    
    toCanvas(document.getElementById("qr"), location.origin + location.pathname + "?room=" + rid);
}

// ----------------------------------------------------------------------
// üåê Peer Initialization and Signaling
// ----------------------------------------------------------------------
function initializePeer(roomId, isInitiator) {
    if (peer && !peer.destroyed) {
        peer.destroy();
    }
    
    const connRef = ref(db, `webrtc_signals/${roomId}`); 
    document.getElementById('connection-status').textContent = 'üü° ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Peer...';

    peer = new SimplePeer({ initiator: isInitiator, trickle: false });

    // Send Signal to Firebase
    peer.on('signal', data => {
        push(connRef, JSON.stringify(data)).catch(e => console.error("Error pushing signal:", e));
    });

    // Receive Signal from Firebase
    onChildAdded(connRef, snap => {
        try {
            const data = JSON.parse(snap.val());
            if (!peer.destroyed && data) {
                peer.signal(data);
            }
        } catch (e) {
            console.error("Error signaling peer:", e);
        }
    });

    // ---------------------- Events ----------------------
    peer.on('connect', () => {
        document.getElementById("chat-box").style.display = "block";
        document.getElementById('connection-status').textContent = 'üü¢ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Peer-to-Peer ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! (‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏´‡∏±‡∏™)';
        addMsg("‚úÖ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏ä‡∏ó‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢");
    });

    peer.on("data", handleReceiveData);
    
    peer.on('error', (err) => {
        document.getElementById('connection-status').textContent = 'üî¥ ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠';
        console.error('Peer Error:', err);
    });
    
    peer.on('close', () => {
        document.getElementById('connection-status').textContent = '‚ö´ ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ñ‡∏π‡∏Å‡∏ï‡∏±‡∏î';
        document.getElementById("chat-box").style.display = "none";
        addMsg("‚ö†Ô∏è ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ñ‡∏π‡∏Å‡∏ï‡∏±‡∏î‡πÅ‡∏•‡πâ‡∏ß ‡πÇ‡∏õ‡∏£‡∏î‡∏•‡∏≠‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà");
    });
}

// ----------------------------------------------------------------------
// üì§ Data Handling (Send Text and Files)
// ----------------------------------------------------------------------
function handleSendText() {
    const text = document.getElementById("message").value.trim();
    if (!text || !peer || peer.destroyed || !peer.connected) return;
    
    try {
        peer.send(JSON.stringify({ type: "text", text, sender: userId.substring(0, 8) }));
        addMsg(`üßç‚Äç‚ôÇÔ∏è (‡∏Ñ‡∏∏‡∏ì): ${text}`);
        document.getElementById("message").value = "";
    } catch (e) {
        console.error("Error sending text:", e);
        addMsg("‚ùå ‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß");
    }
}

function handleSendFile(e) {
    const file = e.target.files[0];
    if (!file || !peer || peer.destroyed || !peer.connected) {
        e.target.value = null; 
        return;
    }

    if (file.size > MAX_FILE_SIZE) {
        addMsg(`‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏î‡πâ: ‡πÑ‡∏ü‡∏•‡πå‡∏°‡∏µ‡∏Ç‡∏ô‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏Å‡∏¥‡∏ô ${(MAX_FILE_SIZE / 1024 / 1024).toFixed(0)}MB`);
        e.target.value = null; 
        return;
    }
    
    const reader = new FileReader();
    reader.onload = () => {
        try {
            peer.send(JSON.stringify({ type: "file", name: file.name, data: reader.result }));
            addMsg(`üì§ ‡∏™‡πà‡∏á‡πÑ‡∏ü‡∏•‡πå: ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)`);
        } catch (e) {
            console.error("Error sending file data:", e);
            addMsg("‚ùå ‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß (‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏≠‡∏≤‡∏à‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ)");
        }
        e.target.value = null; 
    };
    reader.readAsDataURL(file);
}

// ----------------------------------------------------------------------
// üì• Data Handling (Receive)
// ----------------------------------------------------------------------
function handleReceiveData(data) {
    try {
        const d = JSON.parse(data);
        if (d.type === "text") {
            const sender = d.sender || 'üë§';
            addMsg(`${sender}: ${d.text}`);
        } else if (d.type === "file") {
            const fileMsg = document.createElement("div");
            fileMsg.className = "msg bg-yellow-100";
            
            const a = document.createElement("a");
            a.href = d.data;
            a.download = d.name;
            a.textContent = `üìÅ ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå: ${d.name} (‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î)`;
            a.target = "_blank";
            a.classList.add('font-bold', 'hover:text-red-600', 'block', 'mt-1');
            
            fileMsg.appendChild(a);
            document.getElementById("messages").appendChild(fileMsg);
            
            const m = document.getElementById("messages");
            m.scrollTop = m.scrollHeight;
        }
    } catch (e) {
        console.error("Error parsing received data:", e);
    }
}

// ----------------------------------------------------------------------
// üí¨ Chat Display
// ----------------------------------------------------------------------
function addMsg(txt){
    const div = document.createElement("div");
    div.textContent = txt;
    div.className = "msg";
    document.getElementById("messages").appendChild(div);
    const m = document.getElementById("messages");
    m.scrollTop = m.scrollHeight;
}

// ----------------------------------------------------------------------
// üöÄ Start Application
// ----------------------------------------------------------------------
window.onload = authenticate;
</script>
</body>
</html>
