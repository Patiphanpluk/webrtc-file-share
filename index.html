<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>File Share Firebase</title>
<style>
body { font-family:sans-serif; background:#f0f4f8; display:flex; justify-content:center; align-items:center; height:100vh;}
.card { background:#fff; padding:30px; border-radius:15px; box-shadow:0 10px 20px rgba(0,0,0,0.1); width:90%; max-width:400px; text-align:center;}
input, button { padding:10px 15px; border-radius:10px; margin:5px 0; font-size:16px;}
button { background:#2563eb; color:white; cursor:pointer;}
#messages { height:150px; overflow-y:auto; background:#f8fafc; padding:10px; border-radius:10px; text-align:left; margin-top:10px;}
.msg { background:#e0f2fe; padding:6px 10px; margin:4px 0; border-radius:8px;}
#qr { margin: 15px auto; }
</style>
</head>
<body>
<div class="card">
<h2>ğŸ“¡ File Share</h2>
<p id="room-id">à¸à¸³à¸¥à¸±à¸‡à¸ªà¸£à¹‰à¸²à¸‡à¸«à¹‰à¸­à¸‡...</p>
<canvas id="qr"></canvas>
<input id="join-room" placeholder="à¸£à¸«à¸±à¸ªà¸«à¹‰à¸­à¸‡à¸—à¸µà¹ˆà¸•à¹‰à¸­à¸‡à¸à¸²à¸£à¹€à¸‚à¹‰à¸²à¸£à¹ˆà¸§à¸¡">
<button id="join-btn">à¹€à¸‚à¹‰à¸²à¸£à¹ˆà¸§à¸¡à¸«à¹‰à¸­à¸‡</button>

<div id="chat-box" style="display:none;">
<div id="messages"></div>
<input id="message" placeholder="à¸à¸´à¸¡à¸à¹Œà¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡">
<button id="send">à¸ªà¹ˆà¸‡</button><br>
<input type="file" id="fileInput">
</div>
</div>

<!-- Modular Firebase + SimplePeer + QR -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getDatabase, ref, push, onChildAdded } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";
import SimplePeer from "https://cdn.jsdelivr.net/npm/simple-peer@9.11.1/simplepeer.min.js";
import QRCode from "https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyDoUsDv0omYdaR-oJL7g9qk21IhRUsIOpM",
  authDomain: "file-share-8bccd.firebaseapp.com",
  databaseURL: "https://file-share-8bccd-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "file-share-8bccd",
  storageBucket: "file-share-8bccd.firebasestorage.app",
  messagingSenderId: "607625231087",
  appId: "1:607625231087:web:f8cc2bde638b2b7ab2791a",
  measurementId: "G-0HLJ1ZEQ53"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// à¸ªà¸£à¹‰à¸²à¸‡à¸«à¹‰à¸­à¸‡
const roomId = Math.random().toString(36).substring(2,10);
document.getElementById("room-id").textContent = "à¸£à¸«à¸±à¸ªà¸«à¹‰à¸­à¸‡: "+roomId;
QRCode.toCanvas(document.getElementById("qr"), location.origin+"?room="+roomId,{width:200});

// Peer
let peer = new SimplePeer({ initiator:true, trickle:false });
const connRef = ref(db, 'rooms/' + roomId);

peer.on('signal', data => push(connRef, JSON.stringify(data)));
onChildAdded(connRef, snap => { const data = JSON.parse(snap.val()); if(!peer.destroyed) peer.signal(data); });

// à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­à¸ªà¸³à¹€à¸£à¹‡à¸ˆ
peer.on('connect', () => { document.getElementById("chat-box").style.display="block"; addMsg("âœ… à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­à¸ªà¸³à¹€à¸£à¹‡à¸ˆ!"); });

// à¸ªà¹ˆà¸‡à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡
document.getElementById("send").onclick = () => {
  const text = document.getElementById("message").value.trim();
  if(!text) return;
  peer.send(JSON.stringify({type:"text", text}));
  addMsg("ğŸ§â€â™‚ï¸: "+text);
  document.getElementById("message").value="";
};

// à¸ªà¹ˆà¸‡à¹„à¸Ÿà¸¥à¹Œ
document.getElementById("fileInput").onchange = e => {
  const file = e.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = () => { peer.send(JSON.stringify({type:"file", name:file.name, data:reader.result})); addMsg("ğŸ“¤ à¸ªà¹ˆà¸‡à¹„à¸Ÿà¸¥à¹Œ: "+file.name); };
  reader.readAsDataURL(file);
};

// à¸£à¸±à¸šà¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡/à¹„à¸Ÿà¸¥à¹Œ
peer.on("data", data => {
  const d = JSON.parse(data);
  if(d.type=="text") addMsg("ğŸ‘¤: "+d.text);
  else if(d.type=="file"){
    const a = document.createElement("a");
    a.href=d.data;
    a.download=d.name;
    a.textContent="ğŸ“ à¸£à¸±à¸šà¹„à¸Ÿà¸¥à¹Œ: "+d.name;
    a.target="_blank";
    const div = document.createElement("div");
    div.appendChild(a);
    document.getElementById("messages").appendChild(div);
  }
});

function addMsg(txt){
  const div = document.createElement("div");
  div.textContent = txt;
  div.className="msg";
  document.getElementById("messages").appendChild(div);
  const m = document.getElementById("messages");
  m.scrollTop = m.scrollHeight;
}

// à¹€à¸‚à¹‰à¸²à¸«à¹‰à¸­à¸‡à¸ˆà¸²à¸ QR / à¸£à¸«à¸±à¸ª
const params = new URLSearchParams(location.search);
const joinRoom = params.get("room");
if(joinRoom){
  peer = new SimplePeer({ initiator:false, trickle:false });
  const joinRef = ref(db, 'rooms/' + joinRoom);
  peer.on('signal', data => push(joinRef, JSON.stringify(data)));
  onChildAdded(joinRef, snap => peer.signal(JSON.parse(snap.val())));
  peer.on('connect', () => { document.getElementById("chat-box").style.display="block"; addMsg("âœ… à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­à¸ªà¸³à¹€à¸£à¹‡à¸ˆ!"); });
  peer.on("data", data => {
    const d = JSON.parse(data);
    if(d.type=="text") addMsg("ğŸ‘¤: "+d.text);
    else if(d.type=="file"){
      const a = document.createElement("a");
      a.href=d.data;
      a.download=d.name;
      a.textContent="ğŸ“ à¸£à¸±à¸šà¹„à¸Ÿà¸¥à¹Œ: "+d.name;
      a.target="_blank";
      const div = document.createElement("div");
      div.className="msg";
      div.appendChild(a);
      document.getElementById("messages").appendChild(div);
    }
  });
}
</script>
</body>
</html>
