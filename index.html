<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>File Share Firebase</title>
<style>
body { font-family:sans-serif; background:#f0f4f8; display:flex; justify-content:center; align-items:center; min-height:100vh;}
.card { background:#fff; padding:30px; border-radius:15px; box-shadow:0 10px 20px rgba(0,0,0,0.1); width:90%; max-width:400px; text-align:center;}
input, button { padding:10px 15px; border-radius:10px; margin:5px 0; font-size:16px; width:calc(100% - 20px);}
button { background:#2563eb; color:white; cursor:pointer;}
#messages { height:150px; overflow-y:auto; background:#f8fafc; padding:10px; border-radius:10px; text-align:left; margin-top:10px;}
.msg { background:#e0f2fe; padding:6px 10px; margin:4px 0; border-radius:8px;}
#qr { margin: 15px auto; }
</style>
</head>
<body>
<div class="card">
<h2>üì° File Share</h2>
<p id="room-id">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á...</p>
<canvas id="qr"></canvas>
<input id="join-room" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏´‡πâ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°">
<button id="join-btn">‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏´‡πâ‡∏≠‡∏á</button>

<div id="chat-box" style="display:none;">
<div id="messages"></div>
<input id="message" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°">
<button id="send">‡∏™‡πà‡∏á</button><br>
<input type="file" id="fileInput">
</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getDatabase, ref, push, onChildAdded } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";
import SimplePeerLib from "https://cdn.jsdelivr.net/npm/simple-peer@9.11.1/simplepeer.min.js";
const SimplePeer = SimplePeerLib.default;
import QRCode from "https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js";

// üîπ Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyDoUsDv0omYdaR-oJL7g9qk21IhRUsIOpM",
  authDomain: "file-share-8bccd.firebaseapp.com",
  databaseURL: "https://file-share-8bccd-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "file-share-8bccd",
  storageBucket: "file-share-8bccd.firebasestorage.app",
  messagingSenderId: "607625231087",
  appId: "1:607625231087:web:f8cc2bde638b2b7ab2791a",
  measurementId: "G-0HLJ1ZEQ53"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// üîπ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà
let roomId = Math.random().toString(36).substring(2,10);
const roomIdEl = document.getElementById("room-id");
roomIdEl.textContent = "‡∏£‡∏´‡∏±‡∏™‡∏´‡πâ‡∏≠‡∏á: "+roomId;

// ‡∏™‡∏£‡πâ‡∏≤‡∏á QR Code
QRCode.toCanvas(document.getElementById("qr"), location.origin+"?room="+roomId,{width:200});

// ‡∏™‡∏£‡πâ‡∏≤‡∏á peer
let peer = new SimplePeer({ initiator:true, trickle:false });
let connRef = ref(db, 'rooms/' + roomId);

// ‡∏™‡πà‡∏á signal ‡πÑ‡∏õ Firebase
peer.on('signal', data => push(connRef, JSON.stringify(data)));

// ‡∏£‡∏±‡∏ö signal ‡∏à‡∏≤‡∏Å Firebase
onChildAdded(connRef, snap => { const data = JSON.parse(snap.val()); if(!peer.destroyed) peer.signal(data); });

// ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠
peer.on('connect', () => { document.getElementById("chat-box").style.display="block"; addMsg("‚úÖ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!"); });

// ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
document.getElementById("send").onclick = () => {
  const text = document.getElementById("message").value.trim();
  if(!text) return;
  peer.send(JSON.stringify({type:"text", text}));
  addMsg("üßç‚Äç‚ôÇÔ∏è: "+text);
  document.getElementById("message").value="";
};

// ‡∏™‡πà‡∏á‡πÑ‡∏ü‡∏•‡πå
document.getElementById("fileInput").onchange = e => {
  const file = e.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = () => { 
    peer.send(JSON.stringify({type:"file", name:file.name, data:reader.result}));
    addMsg("üì§ ‡∏™‡πà‡∏á‡πÑ‡∏ü‡∏•‡πå: "+file.name); 
  };
  reader.readAsDataURL(file);
};

// ‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° / ‡πÑ‡∏ü‡∏•‡πå
peer.on("data", data => {
  const d = JSON.parse(data);
  if(d.type=="text") addMsg("üë§: "+d.text);
  else if(d.type=="file"){
    const a = document.createElement("a");
    a.href=d.data;
    a.download=d.name;
    a.textContent="üìÅ ‡∏£‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå: "+d.name;
    a.target="_blank";
    const div = document.createElement("div");
    div.className="msg";
    div.appendChild(a);
    document.getElementById("messages").appendChild(div);
  }
});

// ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏ô‡πÅ‡∏ä‡∏ó
function addMsg(txt){
  const div = document.createElement("div");
  div.textContent = txt;
  div.className="msg";
  document.getElementById("messages").appendChild(div);
  const m = document.getElementById("messages");
  m.scrollTop = m.scrollHeight;
}

// ‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡πâ‡∏≠‡∏á‡∏à‡∏≤‡∏Å QR / ‡∏£‡∏´‡∏±‡∏™
const params = new URLSearchParams(location.search);
const joinRoom = params.get("room");
document.getElementById("join-btn").onclick = () => {
  const r = document.getElementById("join-room").value.trim();
  if(r) joinRoomFunc(r);
};
if(joinRoom) joinRoomFunc(joinRoom);

function joinRoomFunc(rid){
  roomIdEl.textContent = "‡∏£‡∏´‡∏±‡∏™‡∏´‡πâ‡∏≠‡∏á: "+rid;
  const joinRef = ref(db, 'rooms/' + rid);
  peer = new SimplePeer({ initiator:false, trickle:false });
  peer.on('signal', data => push(joinRef, JSON.stringify(data)));
  onChildAdded(joinRef, snap => peer.signal(JSON.parse(snap.val())));
  peer.on('connect', () => { document.getElementById("chat-box").style.display="block"; addMsg("‚úÖ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!"); });
  peer.on("data", data => {
    const d = JSON.parse(data);
    if(d.type=="text") addMsg("üë§: "+d.text);
    else if(d.type=="file"){
      const a = document.createElement("a");
      a.href=d.data;
      a.download=d.name;
      a.textContent="üìÅ ‡∏£‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå: "+d.name;
      a.target="_blank";
      const div = document.createElement("div");
      div.className="msg";
      div.appendChild(a);
      document.getElementById("messages").appendChild(div);
    }
  });
  QRCode.toCanvas(document.getElementById("qr"), location.origin+"?room="+rid,{width:200});
}
</script>
</body>
</html>
