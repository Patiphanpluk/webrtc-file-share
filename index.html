<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>File Share Firebase Modular SDK</title>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getDatabase, ref, push, onChildAdded } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";
import SimplePeer from "https://cdn.jsdelivr.net/npm/simple-peer@9.11.1/simplepeer.min.js";
import QRCode from "https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js";

// ğŸ”¹ Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyDoUsDv0omYdaR-oJL7g9qk21IhRUsIOpM",
  authDomain: "file-share-8bccd.firebaseapp.com",
  databaseURL: "https://file-share-8bccd-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "file-share-8bccd",
  storageBucket: "file-share-8bccd.firebasestorage.app",
  messagingSenderId: "607625231087",
  appId: "1:607625231087:web:f8cc2bde638b2b7ab2791a",
  measurementId: "G-0HLJ1ZEQ53"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// ğŸ”¹ à¸ªà¸£à¹‰à¸²à¸‡à¸«à¹‰à¸­à¸‡
const roomId = Math.random().toString(36).substring(2,10);
document.body.innerHTML = `
<h2>ğŸ“¡ File Share</h2>
<p id="room-id">à¸£à¸«à¸±à¸ªà¸«à¹‰à¸­à¸‡: ${roomId}</p>
<canvas id="qr"></canvas>
<div id="chat-box" style="display:none;">
  <div id="messages" style="height:150px; overflow-y:auto; background:#f0f0f0; padding:10px;"></div>
  <input id="message" placeholder="à¸à¸´à¸¡à¸à¹Œà¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡">
  <button id="send">à¸ªà¹ˆà¸‡</button><br>
  <input type="file" id="fileInput">
</div>
`;
QRCode.toCanvas(document.getElementById("qr"), location.origin+"?room="+roomId,{width:200});

// ğŸ”¹ Peer
let peer = new SimplePeer({ initiator:true, trickle:false });
const connRef = ref(db, 'rooms/' + roomId);

peer.on('signal', data => push(connRef, JSON.stringify(data)));
onChildAdded(connRef, snap => { const data = JSON.parse(snap.val()); if(!peer.destroyed) peer.signal(data); });

// à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­à¸ªà¸³à¹€à¸£à¹‡à¸ˆ
peer.on('connect', () => { document.getElementById("chat-box").style.display="block"; addMsg("âœ… à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­à¸ªà¸³à¹€à¸£à¹‡à¸ˆ!"); });

// à¸ªà¹ˆà¸‡à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡
document.getElementById("send").onclick = () => {
  const text = document.getElementById("message").value.trim();
  if(!text) return;
  peer.send(JSON.stringify({type:"text", text}));
  addMsg("ğŸ§â€â™‚ï¸: "+text);
  document.getElementById("message").value="";
};

// à¸ªà¹ˆà¸‡à¹„à¸Ÿà¸¥à¹Œ
document.getElementById("fileInput").onchange = e => {
  const file = e.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = () => { peer.send(JSON.stringify({type:"file", name:file.name, data:reader.result})); addMsg("ğŸ“¤ à¸ªà¹ˆà¸‡à¹„à¸Ÿà¸¥à¹Œ: "+file.name); };
  reader.readAsDataURL(file);
};

// à¸£à¸±à¸šà¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡/à¹„à¸Ÿà¸¥à¹Œ
peer.on("data", data => {
  const d = JSON.parse(data);
  if(d.type=="text") addMsg("ğŸ‘¤: "+d.text);
  else if(d.type=="file"){
    const a = document.createElement("a");
    a.href=d.data;
    a.download=d.name;
    a.textContent="ğŸ“ à¸£à¸±à¸šà¹„à¸Ÿà¸¥à¹Œ: "+d.name;
    a.target="_blank";
    const div = document.createElement("div");
    div.appendChild(a);
    document.getElementById("messages").appendChild(div);
  }
});

function addMsg(txt){
  const div = document.createElement("div");
  div.textContent = txt;
  document.getElementById("messages").appendChild(div);
  const m = document.getElementById("messages");
  m.scrollTop = m.scrollHeight;
}
</script>
</head>
<body>
</body>
</html>
